import matplotlib.pyplot as plt
import numpy as np
import matplotlib.patches as mpatches
from matplotlib.colors import to_rgb
from perception import PerceptionSystem
from color import ColorMapper
from reasoning import ReasoningEngine



grid_in = [
    # 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14
    [0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0], # 0
    [0, 1, 1, 0, 0, 0, 0, 5, 0, 0, 3, 3, 3, 0, 0], # 1 (Bleu: L inversé) + (Vert: Barre)
    [0, 1, 0, 0, 0, 0, 0, 5, 0, 0, 0, 3, 0, 0, 0], # 2
    [0, 1, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0], # 3 (Mur Gris qui serpente)
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0], # 4
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0], # 5
    [6, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0], # 6 (Magenta: Petit bloc)
    [6, 6, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0], # 7
    [6, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 0, 0], # 8
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0], # 9
    [0, 0, 0, 0, 0, 0, 5, 0, 2, 2, 2, 2, 2, 0, 0], # 10 (Rouge: Conteneur complexe)
    [0, 0, 0, 0, 0, 0, 5, 0, 2, 0, 0, 0, 2, 0, 0], # 11
    [0, 0, 0, 0, 0, 0, 5, 0, 2, 0, 0, 0, 2, 0, 0], # 12
    [0, 0, 0, 0, 0, 0, 5, 0, 2, 2, 2, 2, 2, 0, 0], # 13
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]  # 14
]

grid_out_expected = [
    # 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14
    [0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0], # 0
    [0, 1, 1, 0, 0, 0, 0, 5, 0, 0, 0, 3, 0, 0, 0], # 1 (Bleu: Symétrie Horizontale !)
    [0, 0, 1, 0, 0, 0, 0, 5, 0, 0, 3, 3, 3, 0, 0], # 2 (Vert: Rotation 90°)
    [0, 0, 1, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0], # 3
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0], # 4
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0], # 5
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0], # 6
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 6, 0, 0], # 7 (Magenta: Translation à travers le mur)
    [0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 6, 6, 6, 0], # 8
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0], # 9
    [0, 0, 0, 0, 0, 0, 5, 0, 2, 2, 2, 2, 2, 0, 0], # 10
    [0, 0, 0, 0, 0, 0, 5, 0, 2, 4, 4, 4, 2, 0, 0], # 11 (Rouge: Remplissage Jaune)
    [0, 0, 0, 0, 0, 0, 5, 0, 2, 4, 4, 4, 2, 0, 0], # 12
    [0, 0, 0, 0, 0, 0, 5, 0, 2, 2, 2, 2, 2, 0, 0], # 13
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]  # 14
]

grid_in = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 0, 2, 2, 0, 4, 4, 4, 4, 4], 
    [0, 0, 2, 2, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 5, 5, 0, 0, 0, 0, 0, 0],
    [0, 0, 5, 5, 0, 0, 0, 0, 0, 0], 
    [0, 0, 5, 5, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 7, 0, 0, 0, 0], 
    [0, 0, 0, 0, 0, 7, 7, 0, 0, 0],
]
grid_out_expected = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 0, 2, 2, 0, 4, 4, 4, 4, 4], 
    [0, 0, 2, 2, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 5, 5, 0, 0, 0, 0, 0, 0],
    [0, 0, 5, 5, 0, 0, 0, 0, 0, 0], 
    [0, 0, 5, 5, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 7, 0, 0, 0, 0], 
    [0, 0, 0, 0, 0, 7, 7, 0, 0, 0],
]

grid_in = [
    [0, 0, 0, 0, 0, 3, 3, 3, 0, 0], 
    [0, 0, 0, 0, 3, 0, 0, 3, 0, 0], 
    [0, 0, 0, 3, 0, 0, 0, 3, 0, 0], 
    [0, 0, 3, 0, 0, 0, 0, 3, 0, 0],
    [0, 0, 3, 0, 0, 0, 0, 3, 3, 0],
    [0, 0, 3, 0, 0, 0, 0, 0, 3, 0], 
    [0, 0, 3, 0, 0, 0, 0, 0, 3, 0],
    [0, 0, 3, 0, 0, 0, 0, 0, 3, 0],
    [0, 0, 0, 3, 3, 3, 3, 3, 0, 0], 
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]
grid_out_expected = [
    [0, 0, 0, 0, 0, 3, 3, 3, 0, 0], 
    [0, 0, 0, 0, 3, 2, 2, 3, 0, 0], 
    [0, 0, 0, 3, 2, 2, 2, 3, 0, 0], 
    [0, 0, 3, 2, 2, 2, 2, 3, 0, 0],
    [0, 0, 3, 2, 2, 2, 2, 3, 3, 0],
    [0, 0, 3, 2, 2, 2, 2, 2, 3, 0], 
    [0, 0, 3, 2, 2, 2, 2, 2, 3, 0],
    [0, 0, 3, 2, 2, 2, 2, 2, 3, 0],
    [0, 0, 0, 3, 3, 3, 3, 3, 0, 0], 
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]

grid_in = [
    # 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14
    [0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0], # 0
    [0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0], # 1
    [0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 2
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 3
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 4
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 5
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 6
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, 0], # 7
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 6, 0, 0], # 8
    [0, 3, 3, 3, 0, 0, 0, 0, 0, 6, 0, 0, 6, 0, 0], # 9
    [0, 3, 3, 3, 0, 0, 0, 0, 0, 6, 0, 0, 6, 0, 0], # 10
    [0, 3, 3, 3, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, 0], # 11
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 12
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 13
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]  # 14
]

grid_out_expected = [
    # 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14
    [0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 0
    [0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 1
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 2
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 3
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0], # 4 (Translation ici)
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0], # 5
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 6
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, 0], # 7
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 8, 8, 6, 0, 0], # 8 (Remplissage 8)
    [0, 4, 4, 4, 0, 0, 0, 0, 0, 6, 8, 8, 6, 0, 0], # 9 (Couleur 3->4)
    [0, 4, 4, 4, 0, 0, 0, 0, 0, 6, 8, 8, 6, 0, 0], # 10
    [0, 4, 4, 4, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, 0], # 11
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 12
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 13
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]  # 14
]

grid_in = [
    # 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14
    [0, 8, 8, 8, 0, 0, 0, 7, 7, 0, 0, 0, 0, 0, 0], # 0 (Cyan T + Orange Carré)
    [0, 0, 8, 0, 0, 0, 0, 7, 7, 0, 0, 0, 0, 0, 0], # 1
    [0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 2
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 3
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0], # 4 (Gris Mur - Start)
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0], # 5
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0], # 6
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 3, 3, 3, 3], # 7 (Gris Mur - End + Vert Cadre Top)
    [0, 1, 0, 1, 0, 0, 5, 0, 0, 0, 0, 3, 0, 0, 3], # 8 (Bleu U + Vert Cadre Vide)
    [0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3], # 9
    [0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3], # 10
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 11
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 12
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 13
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]  # 14
]

grid_out_expected = [
    # 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14
    [0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 0 (Cyan a tourné: T couché)
    [0, 8, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 1
    [0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 2
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 7, 0, 0, 0], # 3 (Orange a bougé ici)
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 7, 7, 0, 0, 0], # 4
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0], # 5
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0], # 6
    [0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 3, 3, 3, 3], # 7
    [0, 9, 0, 9, 0, 0, 5, 0, 0, 0, 0, 3, 2, 2, 3], # 8 (Bleu->Maroon + Remplissage Rouge)
    [0, 9, 0, 9, 0, 0, 0, 0, 0, 0, 0, 3, 2, 2, 3], # 9
    [0, 9, 9, 9, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3], # 10
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 11
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 12
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], # 13
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]  # 14
]

grid_in = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 3, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 3, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 3, 3, 3, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]
grid_out_expected = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 4, 4, 4, 0, 0, 0, 0, 0, 0], 
    [0, 4, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 4, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]
# --- 2. PROCESSING ---
ps = PerceptionSystem()
objs_in = ps.extract_objects(grid_in)
objs_out = ps.extract_objects(grid_out_expected)

engine = ReasoningEngine()
transformations = engine.compare_grids(objs_in, objs_out, grid_out_expected)

# --- 3. VISUALIZATION ---

def grid_to_rgb(grid):
    h, w = len(grid), len(grid[0])
    rgb_array = np.zeros((h, w, 3))
    for y in range(h):
        for x in range(w):
            rgb_array[y, x] = to_rgb(ColorMapper.hex(int(grid[y][x])))
    return rgb_array

def show_full_analysis(g_in, g_out, objs_found, transforms):
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 8))
    
    # --- 1. Input ---
    ax1.imshow(grid_to_rgb(g_in))
    ax1.set_title("INPUT (Detection)", fontsize=14, fontweight='bold', pad=20)
    
    detected_text = "Objects detected :\n" + "\n".join([f"- {o.shape} ({ColorMapper.name(o.color_code)})" for o in objs_found])
    
    ax1.text(0.5, -0.15, detected_text, transform=ax1.transAxes, 
             verticalalignment='top', horizontalalignment='center',
             fontsize=10, bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))

    # --- 2. Output ---
    ax2.imshow(grid_to_rgb(g_out))
    ax2.set_title("OUTPUT (Target)", fontsize=14, fontweight='bold', pad=20)
    
    trans_text = "Detected transformations :\n"
    for t in transforms:
        if isinstance(t, str): trans_text += f"- {t}\n"
        else: trans_text += f"- {t.obj_in.shape}: {' + '.join(t.actions)}\n"
    
    ax2.text(0.5, -0.15, trans_text, transform=ax2.transAxes, 
             verticalalignment='top', horizontalalignment='center',
             fontsize=10, bbox=dict(boxstyle='round', facecolor='lightblue', alpha=0.5))

    plt.subplots_adjust(top=0.85, bottom=0.3, left=0.1, right=0.9, wspace=0.3)
    
    fig.canvas.manager.set_window_title('BRAIN Analysis - Reasoning System')

    for ax in [ax1, ax2]:
        h, w = len(g_in), len(g_in[0])
        ax.set_xticks(np.arange(-0.5, w, 1), minor=True)
        ax.set_yticks(np.arange(-0.5, h, 1), minor=True)
        ax.grid(which='minor', color='white', linewidth=1)
        ax.tick_params(which='both', bottom=False, left=False, labelbottom=False, labelleft=False)

    plt.show()

# --- 4. LAUNCH ---
show_full_analysis(grid_in, grid_out_expected, objs_in, transformations)